<!-- Generated by pkgdown: do not edit by hand -->
<!DOCTYPE html>
<html lang="en">
  <head>
  <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<title>Iterative heuristic cross-temporal forecast reconciliation — iterec • FoReco</title>

<!-- favicons -->
<link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png" />
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png" />
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png" />
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png" />

<!-- jquery -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script>
<!-- Bootstrap -->

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous" />

<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script>

<!-- bootstrap-toc -->
<link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script>

<!-- Font Awesome icons -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous" />

<!-- clipboard.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script>

<!-- headroom.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script>

<!-- pkgdown -->
<link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script>




<meta property="og:title" content="Iterative heuristic cross-temporal forecast reconciliation — iterec" />
<meta property="og:description" content="Iterative procedure which produces cross-temporally reconciled
forecasts by alternating forecast reconciliation along one single dimension
(either cross-sectional or temporal) at each iteration step. Each iteration
consists in the first two steps of the heuristic KA procedure, so the forecasts are
reconciled by alternating cross-sectional (contemporaneous) reconciliation, and
reconciliation through temporal hierarchies in a cyclic fashion.
The choice of the dimension along with the first reconciliation step in each
iteration is performed is up to the user (param start_rec), and there is
no particular reason why one should perform the temporal reconciliation first, and
the cross-sectional reconciliation then.
The iterative procedure allows the user to get non-negative reconciled forecasts." />
<meta property="og:image" content="https://danigiro.github.io/FoReco/logo.svg" />




<!-- mathjax -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script>

<!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->



  </head>

  <body data-spy="scroll" data-target="#toc">
    <div class="container template-reference-topic">
      <header>
      <div class="navbar navbar-inverse navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">FoReco</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.1.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        <li>
  <a href="../index.html">
    <span class="fa fa-home"></span>
     
    Home
  </a>
</li>
<li>
  <a href="../reference/index.html">
    <span class="fa fa-book"></span>
     
    Reference
  </a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    <span class="fa fa-question-circle"></span>
     
    Vignettes
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li>
      <a href="../articles/FoReco_package.html">Using the FoReco package</a>
    </li>
    <li>
      <a href="../articles/accuracy_indices.html">Average relative accuracy indices</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">
    <span class="far fa far fa-newspaper"></span>
     
    News
  </a>
</li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
        <li>
  <a href="https://github.com/daniGiro/FoReco">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="https://cran.r-project.org/web/packages/FoReco/index.html">
    <span class="fab fa fab fa-r-project fa-lg"></span>
     
  </a>
</li>
      </ul>
      
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

      

      </header>

<div class="row">
  <div class="col-md-9 contents">
    <div class="page-header">
    <h1>Iterative heuristic cross-temporal forecast reconciliation</h1>
    <small class="dont-index">Source: <a href='https://github.com/daniGiro/FoReco/blob/master/R/iterec.R'><code>R/iterec.R</code></a></small>
    <div class="hidden name"><code>iterec.Rd</code></div>
    </div>

    <div class="ref-description">
    <p>Iterative procedure which produces cross-temporally reconciled
forecasts by alternating forecast reconciliation along one single dimension
(either cross-sectional or temporal) at each iteration step. <strong>Each iteration</strong>
consists in the first two steps of the heuristic KA procedure, so the forecasts are
reconciled by alternating cross-sectional (contemporaneous) reconciliation, and
reconciliation through temporal hierarchies in a cyclic fashion.
The choice of the dimension along with the first reconciliation step in each
iteration is performed is up to the user (param <code>start_rec</code>), and there is
no particular reason why one should perform the temporal reconciliation first, and
the cross-sectional reconciliation then.
The iterative procedure allows the user to get non-negative reconciled forecasts.</p>
    </div>

    <pre class="usage"><span class='fu'>iterec</span>(<span class='no'>basef</span>, <span class='no'>m</span>, <span class='no'>C</span>, <span class='no'>thf_comb</span>, <span class='no'>hts_comb</span>, <span class='no'>Ut</span>, <span class='no'>nb</span>, <span class='no'>res</span>, <span class='no'>W</span>,
       <span class='no'>Omega</span>, <span class='kw'>mse</span> <span class='kw'>=</span> <span class='fl'>TRUE</span>, <span class='kw'>corpcor</span> <span class='kw'>=</span> <span class='fl'>FALSE</span>,<span class='kw'>type</span> <span class='kw'>=</span> <span class='st'>"M"</span>,
       <span class='kw'>sol</span> <span class='kw'>=</span> <span class='st'>"direct"</span>, <span class='kw'>nn</span> <span class='kw'>=</span> <span class='fl'>FALSE</span>, <span class='kw'>maxit</span> <span class='kw'>=</span> <span class='fl'>100</span>, <span class='kw'>tol</span> <span class='kw'>=</span> <span class='fl'>1e-5</span>,
       <span class='kw'>start_rec</span> <span class='kw'>=</span> <span class='st'>"auto"</span>, <span class='kw'>note</span> <span class='kw'>=</span> <span class='fl'>TRUE</span>, <span class='kw'>plot</span> <span class='kw'>=</span> <span class='st'>"mti"</span>,
       <span class='kw'>settings</span> <span class='kw'>=</span> <span class='fu'>osqpSettings</span>(<span class='kw'>verbose</span> <span class='kw'>=</span> <span class='fl'>FALSE</span>, <span class='kw'>eps_abs</span> <span class='kw'>=</span> <span class='fl'>1e-5</span>,
       <span class='kw'>eps_rel</span> <span class='kw'>=</span> <span class='fl'>1e-5</span>, <span class='kw'>polish_refine_iter</span> <span class='kw'>=</span> <span class='fl'>100</span>, <span class='kw'>polish</span> <span class='kw'>=</span> <span class='fl'>TRUE</span>))</pre>

    <h2 class="hasAnchor" id="arguments"><a class="anchor" href="#arguments"></a>Arguments</h2>
    <table class="ref-arguments">
    <colgroup><col class="name" /><col class="desc" /></colgroup>
    <tr>
      <th>basef</th>
      <td><p>(<code>n x h(k* + m)</code>) matrix of base forecasts to be reconciled;
<code>n</code> is the total number of variables, <code>m</code> is the highest frequency,
<code>k*</code> is the sum of (<code>p-1</code>) factors of <code>m</code>, excluding <code>m</code>,
and <code>h</code> is the forecast horizon. Each row identifies, a time series, and the forecasts
are ordered as [lowest_freq' ...  highest_freq']'.</p></td>
    </tr>
    <tr>
      <th>m</th>
      <td><p>Highest available sampling frequency per seasonal cycle (max. order of temporal aggregation).</p></td>
    </tr>
    <tr>
      <th>C</th>
      <td><p>(<code>na x nb</code>) cross-sectional (contemporaneous) matrix mapping the bottom
level series into the higher level ones.</p></td>
    </tr>
    <tr>
      <th>thf_comb</th>
      <td><p>Type of the (<code>(k* + m) x (k* + m)</code>) covariance matrix to be used in
the temporal reconciliation, see more in <code>comb</code> param of <code><a href='thfrec.html'>thfrec</a></code>.</p></td>
    </tr>
    <tr>
      <th>hts_comb</th>
      <td><p>Type of the (<code>n x n</code>) covariance matrix to be used in the
cross-sectional reconciliation, see more in <code>comb</code> param of <code><a href='htsrec.html'>htsrec</a></code>.</p></td>
    </tr>
    <tr>
      <th>Ut</th>
      <td><p>Zero constraints cross-sectional (contemporaneous) kernel matrix
\((\textbf{U}'\textbf{Y} = \mathbf{0})\) spanning the null space valid for the reconciled
forecasts. It can be used instead of parameter <code>C</code>, but in this case <code>nb</code> (n = na + nb) is needed. If
the hierarchy admits a structural representation, <code>Ut</code> has dimension (<code>na x n</code>).</p></td>
    </tr>
    <tr>
      <th>nb</th>
      <td><p>Number of bottom time series; if <code>C</code> is present, <code>nb</code> is not used.</p></td>
    </tr>
    <tr>
      <th>res</th>
      <td><p>(<code>n x N(k* + m)</code>) matrix containing the residuals at all the
temporal frequencies ordered [lowest_freq' ...  highest_freq']' (columns) for
each variable (row), needed to estimate the covariance matrix when <code>hts_comb =</code>
<code>{"wls",</code> <code>"shr",</code> <code>"sam"}</code> and/or <code>hts_comb =</code> <code>{"wlsv",</code>
<code>"wlsh",</code> <code>"acov",</code> <code>"strar1",</code> <code>"sar1",</code> <code>"har1",</code>
<code>"shr",</code> <code>"sam"}</code>. The row must be in the same order as <code>basef</code>.</p></td>
    </tr>
    <tr>
      <th>W</th>
      <td><p>This option permits to directly enter the covariance matrix in the
cross-sectional reconciliation, see more in <code>W</code> param of <code><a href='htsrec.html'>htsrec</a></code>.</p></td>
    </tr>
    <tr>
      <th>Omega</th>
      <td><p>This option permits to directly enter the covariance matrix in the
reconciliation through temporal hierarchies, see more in <code>Omega</code> param of <code><a href='thfrec.html'>thfrec</a></code>.</p></td>
    </tr>
    <tr>
      <th>mse</th>
      <td><p>Logical value: <code>TRUE</code> (<em>default</em>) calculates the
covariance matrix of the in-sample residuals (when necessary) according to the original
<span class="pkg">hts</span> and <span class="pkg">thief</span> formulation: no mean correction, T as denominator.</p></td>
    </tr>
    <tr>
      <th>corpcor</th>
      <td><p>Logical value: <code>TRUE</code> if <span class="pkg">corpcor</span> (Schäfer et
al., 2017) must be used to shrink the sample covariance matrix according to
Schäfer and Strimmer (2005), otherwise the function uses the same
implementation as package <span class="pkg">hts</span>.</p></td>
    </tr>
    <tr>
      <th>type</th>
      <td><p>Approach used to compute the reconciled forecasts: <code>"M"</code> for
the projection approach with matrix M (<em>default</em>), or <code>"S"</code> for the
structural approach with summing matrix S.</p></td>
    </tr>
    <tr>
      <th>sol</th>
      <td><p>Solution technique for the reconciliation problem: either <code>"direct"</code> for the direct
solution or <code>"osqp"</code> for the numerical solution (solving a linearly constrained quadratic
program using <code><a href='https://rdrr.io/pkg/osqp/man/solve_osqp.html'>solve_osqp</a></code>).</p></td>
    </tr>
    <tr>
      <th>nn</th>
      <td><p>Logical value: <code>TRUE</code> if non-negative reconciled forecasts are wished.</p></td>
    </tr>
    <tr>
      <th>maxit</th>
      <td><p>Max number of iteration (<code>100</code>, <em>default</em>).</p></td>
    </tr>
    <tr>
      <th>tol</th>
      <td><p>Convergence tolerance (<code>1e-5</code>, <em>default</em>).</p></td>
    </tr>
    <tr>
      <th>start_rec</th>
      <td><p>Dimension along with the first reconciliation step in each
iteration is performed: it start from temporal reconciliation with "<code>thf</code>",
from cross-sectional with "<code>hts</code>" and it does both reconciliation with "<code>auto</code>" (<em>default</em>).</p></td>
    </tr>
    <tr>
      <th>note</th>
      <td><p>If <code>note = TRUE</code> (<em>default</em>) the function writes some notes to the console,
otherwise no note is produced (also no plot).</p></td>
    </tr>
    <tr>
      <th>plot</th>
      <td><p>Some useful plots: <code>"mti"</code> (<em>default</em>) marginal trend inconsistencies,
<code>"pat"</code> step by step inconsistency pattern for each iteration, <code>"distf"</code> distance
forecasts iteration i and i-1, <code>"all"</code> all the plots.</p></td>
    </tr>
    <tr>
      <th>settings</th>
      <td><p>Settings for <span class="pkg">osqp</span> (object <code><a href='https://rdrr.io/pkg/osqp/man/osqpSettings.html'>osqpSettings</a></code>). The default options
are: <code>verbose = FALSE</code>, <code>eps_abs = 1e-5</code>, <code>eps_rel = 1e-5</code>,
<code>polish_refine_iter = 100</code> and <code>polish = TRUE</code>. For details, see the
<a href='https://osqp.org/'><span class="pkg">osqp</span> documentation</a> (Stellato et al. 2019).</p></td>
    </tr>
    </table>

    <h2 class="hasAnchor" id="value"><a class="anchor" href="#value"></a>Value</h2>

    <p><code>iterec</code> returns a list with:</p>
<dt><code>recf</code></dt><dd><p>(<code>n x h(k* + m)</code>) matrix of reconciled forecasts.</p></dd>
<dt><code>d_cs</code></dt><dd><p>Cross-sectional incoherence at each iteration.</p></dd>
<dt><code>d_te</code></dt><dd><p>Temporal incoherence at each iteration.</p></dd>
<dt><code>start_rec</code></dt><dd><p>Starting coherence dimension (thf or hts).</p></dd>
<dt><code>tol</code></dt><dd><p>Tolerance.</p></dd>
<dt><code>flag</code></dt><dd><p>Control code (see <em>details</em>).</p></dd>
<dt><code>time</code></dt><dd><p>Elapsed time.</p></dd>
<dt><code>dist</code></dt><dd><p>If <code>start_rec = "auto"</code>, matrix of distances of the forecasts reconciled
from the base.</p></dd>

    <h2 class="hasAnchor" id="details"><a class="anchor" href="#details"></a>Details</h2>

    <p>The above procedure can be seen as an extension of the well known iterative proportional
fitting procedure (Deming and Stephan, 1940, Johnston and Pattie, 1993), also known as
RAS method (Miller and Blair, 2009), to adjust the internal cell values of a
two-dimensional matrix until they sum to some predetermined row and column
totals. In that case the adjustment follows a proportional adjustment scheme, whereas
in the cross-temporal reconciliation framework each adjustment step is made according to
the penalty function associated to the single-dimension reconciliation procedure adopted.</p>
<p>Control status of iterative reconciliation:</p><dl'>
<dt><code>-2</code></dt><dd><p>Temporal/Cross-sectional reconciliation does not work.</p></dd>
<dt><code>-1</code></dt><dd><p>Convergence not achieved (maximum iteration limit reached).</p></dd>
<dt><code>0</code></dt><dd><p>Convergence achieved.</p></dd>
<dt><code>+1</code></dt><dd><p>Convergence achieved: incoherence has increased in the next
iteration (at least one time).</p></dd>
<dt><code>+2</code></dt><dd><p>Convergence achieved: incoherence has increased in the next
two or more iteration (at least one time).</p></dd>
<dt><code>+3</code></dt><dd><p>The forecasts are already reconciled.</p></dd>

</dl>

    <h2 class="hasAnchor" id="references"><a class="anchor" href="#references"></a>References</h2>

    <p>Deming, E., Stephan, F.F. (1940), On a least squares adjustment of a sampled frequency
table when the expected marginal totals are known, <em>The Annals of Mathematical
Statistics</em>, 11, 4, 427–444.</p>
<p>Di Fonzo, T., Girolimetto, D. (2020), Cross-Temporal Forecast Reconciliation:
Optimal Combination Method and Heuristic Alternatives, Department of Statistical
Sciences, University of Padua, <a href='https://arxiv.org/abs/2006.08570'>arXiv:2006.08570</a>.</p>
<p>Johnston, R.J., Pattie, C.J. (1993), Entropy-Maximizing and the Iterative Proportional
Fitting Procedure, <em>The Professional Geographer</em>, 45, 3, 317–322.</p>
<p>Kourentzes, N., Athanasopoulos, G. (2019), Cross-temporal coherent forecasts
for Australian tourism, <em>Annals of Tourism Research</em>, 75, 393-409.</p>
<p>Miller, R.E., Blair, P.D. (2009), Input-output analysis: foundations and extensions,
2nd edition, New York, Cambridge University Press.</p>
<p>Schäfer, J.L., Opgen-Rhein, R., Zuber, V., Ahdesmaki, M.,
Duarte Silva, A.P., Strimmer, K. (2017), <em>Package `corpcor'</em>, R
package version 1.6.9 (April 1, 2017), <a href='https://CRAN.R-project.org/package=corpcor'>https://CRAN.R-project.org/package= corpcor</a>.</p>
<p>Schäfer, J.L., Strimmer, K. (2005), A Shrinkage Approach to Large-Scale Covariance
Matrix Estimation and Implications for Functional Genomics, <em>Statistical
Applications in Genetics and Molecular Biology</em>, 4, 1.</p>
<p>Stellato, B., Banjac, G., Goulart, P., Bemporad, A., Boyd, S. (2018). OSQP:
An Operator Splitting Solver for Quadratic Programs, <a href='https://arxiv.org/abs/1711.08013'>arXiv:1711.08013</a>.</p>
<p>Stellato, B., Banjac, G., Goulart, P., Boyd, S., Anderson, E. (2019), OSQP:
Quadratic Programming Solver using the 'OSQP' Library, R package version 0.6.0.3
(October 10, 2019), <a href='https://CRAN.R-project.org/package=osqp'>https://CRAN.R-project.org/package=osqp</a>.</p>

    <h2 class="hasAnchor" id="examples"><a class="anchor" href="#examples"></a>Examples</h2>
    <pre class="examples"><div class='input'><span class='kw'>if</span> (<span class='fl'>FALSE</span>) {
<span class='fu'><a href='https://rdrr.io/r/utils/data.html'>data</a></span>(<span class='no'>FoReco_data</span>)
<span class='no'>obj</span> <span class='kw'>&lt;-</span> <span class='fu'>iterec</span>(<span class='no'>FoReco_data</span>$<span class='no'>base</span>,
  <span class='kw'>m</span> <span class='kw'>=</span> <span class='fl'>12</span>, <span class='kw'>C</span> <span class='kw'>=</span> <span class='no'>FoReco_data</span>$<span class='no'>C</span>, <span class='kw'>thf_comb</span> <span class='kw'>=</span> <span class='st'>"acov"</span>,
  <span class='kw'>hts_comb</span> <span class='kw'>=</span> <span class='st'>"shr"</span>, <span class='kw'>res</span> <span class='kw'>=</span> <span class='no'>FoReco_data</span>$<span class='no'>res</span>, <span class='kw'>start_rec</span> <span class='kw'>=</span> <span class='st'>"thf"</span>)
}</div></pre>
  </div>
  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">
    <nav id="toc" data-toggle="toc" class="sticky-top">
      <h2 data-toc-skip>Contents</h2>
    </nav>
  </div>
</div>


      <footer>
      <div class="copyright">
  <p>Developed by Tommaso Di Fonzo, Daniele Girolimetto.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.5.1.</p>
</div>

      </footer>
   </div>

  


  </body>
</html>


