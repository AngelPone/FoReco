<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Probabilistic forecast reconciliation • FoReco</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/cosmo/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Probabilistic forecast reconciliation">
<meta property="og:description" content="FoReco">
<meta property="og:image" content="https://danigiro.github.io/FoReco/logo.svg">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    

    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">FoReco</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Unreleased version">0.2.6</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fa fa-home"></span>
     
    Home
  </a>
</li>
<li>
  <a href="../reference/index.html">
    <span class="fa fa-book"></span>
     
    Reference
  </a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    <span class="fa fa-question-circle"></span>
     
    Vignettes
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/FoReco_package.html">Using the FoReco package</a>
    </li>
    <li>
      <a href="../articles/accuracy_indices.html">Average relative accuracy indices</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">
    <span class="far fa-newspaper"></span>
     
    News
  </a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/daniGiro/FoReco" class="external-link">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="https://cran.r-project.org/web/packages/FoReco/index.html" class="external-link">
    <span class="fab fa-r-project fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Probabilistic forecast reconciliation</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/daniGiro/FoReco/blob/HEAD/vignettes/articles/aticolo.Rmd" class="external-link"><code>vignettes/articles/aticolo.Rmd</code></a></small>
      <div class="hidden name"><code>aticolo.Rmd</code></div>

    </div>

    
    
<p>Probabilistic forecast reconciliation is a powerful technique for
generating coherent and accurate forecasts across multiple time series.
<code>FoReco</code> is an R package that provides an implementation of
this technique, using the methods proposed by Panagiotelis et al. (2022)
and Girolimetto et al. (2023). The package is flexible and can be used
to perform reconciliation on cross-sectional, temporal, and
cross-temporal data. It also allows for the specification of constraints
and can handle both point and probabilistic forecasts. In this vignette,
we will walk through the basics of using <code>FoReco</code> for
probabilistic forecast reconciliation.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://pkg.robjhyndman.com/forecast/" class="external-link">forecast</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="http://www.stats.ox.ac.uk/pub/MASS4/" class="external-link">MASS</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/daniGiro/FoReco" class="external-link">FoReco</a></span><span class="op">)</span></span>
<span><span class="va">B</span> <span class="op">&lt;-</span> <span class="fl">1000</span> <span class="co"># Sample size</span></span></code></pre></div>
<div class="section level3">
<h3 id="cross-sectional-framework">Cross-sectional framework<a class="anchor" aria-label="anchor" href="#cross-sectional-framework"></a>
</h3>
<p>Let’s take a look at how <code>FoReco</code> can be used for
cross-sectional reconciliation. We begin by considering an example of
cross-sectional reconciliation. Suppose we have data (<a href="https://search.r-project.org/R/refmans/datasets/html/UKLungDeaths.html" class="external-link">UKLungDeaths</a>
dataset) on the monthly deaths from bronchitis, emphysema and asthma in
the UK, 1974–1979 (Diggle, 1990), both sexes (<strong>Total</strong>),
males (<strong>Male</strong>) and females (<strong>Female</strong>). We
want to generate forecasts for these variables, but we also want to
ensure that the forecasts are consistent with each other.</p>
<p><img src="aticolo_files/figure-html/cs_plot-1.png" width="576" style="display: block; margin: auto;"></p>
<p>We start with the example of cross-sectional reconciliation, where we
want to reconcile base forecasts for the total, males’ and females’
number of deaths such that <span class="math inline">\(Total = Male +
Female\)</span>. We first arrange the data frame of deaths, the
aggregation matrix, and the constraint matrix. Then, we generate the
base forecasts using the <a href="https://pkg.robjhyndman.com/forecast/reference/ets.html" class="external-link"><code>ets()</code></a>
(ETS model) and <a href="https://pkg.robjhyndman.com/forecast/reference/forecast.ets.html" class="external-link"><code>forecast()</code></a>
function from the <a href="https://pkg.robjhyndman.com/forecast/index.html" class="external-link"><strong>forecast</strong></a>
package.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Cross-sectional setup</span></span>
<span><span class="va">tdeaths</span> <span class="op">&lt;-</span> <span class="va">mdeaths</span> <span class="op">+</span> <span class="va">fdeaths</span></span>
<span><span class="va">agg_mat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">cons_cs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="fl">1</span>,<span class="op">-</span><span class="va">agg_mat</span><span class="op">)</span></span>
<span><span class="va">lungDeaths</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="va">tdeaths</span>, <span class="va">mdeaths</span>, <span class="va">fdeaths</span><span class="op">)</span></span>
<span></span>
<span><span class="va">fit</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="va">lungDeaths</span>, <span class="fl">2</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="https://pkg.robjhyndman.com/forecast/reference/ets.html" class="external-link">ets</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/ts.html" class="external-link">ts</a></span><span class="op">(</span><span class="va">x</span>, frequency <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/time.html" class="external-link">frequency</a></span><span class="op">(</span><span class="va">lungDeaths</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">forecast_obj</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">fit</span>, <span class="va">forecast</span>, h<span class="op">=</span><span class="fl">12</span><span class="op">)</span>      <span class="co"># forecast object</span></span>
<span><span class="va">base</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="va">forecast_obj</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="va">x</span><span class="op">$</span><span class="va">mean</span><span class="op">)</span> <span class="co"># base mean </span></span>
<span><span class="va">res</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="va">fit</span>, <span class="va">residuals</span>, type<span class="op">=</span><span class="st">'response'</span><span class="op">)</span>   <span class="co"># in-sample residuals (one-step)</span></span></code></pre></div>
<div class="section level4">
<h4 id="bootstrap-approach">Bootstrap approach<a class="anchor" aria-label="anchor" href="#bootstrap-approach"></a>
</h4>
<p>The first approach is the block bootstrap method proposed by
Panagiotelis et al. (2022). To implement this method, we utilize the
<code><a href="../reference/boot_cs.html">boot_cs()</a></code> function, which requires three inputs. Firstly,
the <strong>fit</strong> parameter, which is a list of models (e.g.,
three ETS models). Secondly, the <strong>boot_size</strong> parameter
specifies the number of boostrap replications, and lastly,
<strong>h</strong> denotes the block size, which is typically equivalent
to the forecast horizon. It is important to note that the models used
have the <a href="https://pkg.robjhyndman.com/forecast/simulate.ets.html" class="external-link"><code>simulate()</code></a>
function available and implemented similarly to the <a href="https://pkg.robjhyndman.com/forecast/" class="external-link"><strong>forecast</strong></a>
package (Hyndman et al. 2023) version, with the following mandatory
parameters: <strong>object</strong>, <strong>innov</strong>,
<strong>future</strong>, and <strong>nsim</strong>. The outputs of the
function are the seed used to sample the errors and a 3-d array (<span class="math inline">\(\mathrm{boot\_size} \times n \times h\)</span>),
which can be reconciled using the <code><a href="../reference/htsrec.html">htsrec()</a></code> function.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Base forecasts' sample</span></span>
<span><span class="va">base_csjb</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/boot_cs.html">boot_cs</a></span><span class="op">(</span><span class="va">fit</span>, <span class="va">B</span>, <span class="fl">12</span><span class="op">)</span><span class="op">$</span><span class="va">sample</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/Matrix/man/norm.html" class="external-link">norm</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="va">base_csjb</span>, <span class="fl">3</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="va">x</span><span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span><span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">cons_cs</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="co"># Check the coherency</span></span>
<span><span class="co">#&gt; [1] 123458</span></span>
<span></span>
<span><span class="co"># Reconciled forecasts' sample</span></span>
<span><span class="va">reco_csjb</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="va">base_csjb</span>, <span class="fl">3</span>, <span class="va">htsrec</span>, C <span class="op">=</span> <span class="va">agg_mat</span>, res <span class="op">=</span> <span class="va">res</span>, </span>
<span>                   comb <span class="op">=</span> <span class="st">"shr"</span>, keep <span class="op">=</span> <span class="st">"recf"</span>, simplify <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="va">reco_csjb</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">simplify2array</a></span><span class="op">(</span><span class="va">reco_csjb</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">reco_csjb</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="cn">NULL</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/Matrix/man/norm.html" class="external-link">norm</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="va">reco_csjb</span>, <span class="fl">3</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="va">x</span><span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span><span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">cons_cs</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="co"># Check the coherency</span></span>
<span><span class="co">#&gt; [1] 1.214175e-10</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="gaussian-approach">Gaussian approach<a class="anchor" aria-label="anchor" href="#gaussian-approach"></a>
</h4>
<p>To obtain the base forecasts sample assuming Gaussianity
(Panagiotelis et al. 2022), we can use packages to simulate from a
multivariate normal distribution such as <a href="https://CRAN.R-project.org/package=MASS" class="external-link"><strong>MASS</strong></a>
(Venables and Ripley 2002) and then apply the <code><a href="../reference/htsrec.html">htsrec()</a></code>
function to obtain the reconciled sample. When we have multiple forecast
horizons, Girolimetto et al. (2023) suggest using multi-step residuals
instead of only one-step residuals.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Multi-step residuals</span></span>
<span><span class="va">hres</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">12</span>, <span class="kw">function</span><span class="op">(</span><span class="va">h</span><span class="op">)</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="va">fit</span>, <span class="va">residuals</span>, type<span class="op">=</span><span class="st">'response'</span>, h <span class="op">=</span> <span class="va">h</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co"># List of H=12 covaraince matrix (one for each forecast horizon)</span></span>
<span><span class="va">cov_shr</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">hres</span>, <span class="kw">function</span><span class="op">(</span><span class="va">r</span><span class="op">)</span> <span class="fu"><a href="../reference/shrink_estim.html">shrink_estim</a></span><span class="op">(</span><span class="va">r</span><span class="op">)</span><span class="op">$</span><span class="va">scov</span><span class="op">)</span> </span>
<span><span class="co"># Base forecasts' sample</span></span>
<span><span class="va">base_csg</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">12</span>, <span class="kw">function</span><span class="op">(</span><span class="va">h</span><span class="op">)</span> <span class="fu">MASS</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/MASS/man/mvrnorm.html" class="external-link">mvrnorm</a></span><span class="op">(</span>n <span class="op">=</span> <span class="va">B</span>, mu <span class="op">=</span> <span class="va">base</span><span class="op">[</span><span class="va">h</span>, <span class="op">]</span>, Sigma <span class="op">=</span> <span class="va">cov_shr</span><span class="op">[[</span><span class="va">h</span><span class="op">]</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">base_csg</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">simplify2array</a></span><span class="op">(</span><span class="va">base_csg</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="va">base_csg</span>, <span class="fl">3</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="va">x</span><span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span><span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">cons_cs</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="co"># Check the coherency</span></span>
<span><span class="co">#&gt; [1] 1211926</span></span>
<span></span>
<span><span class="co"># Reconciled forecasts' sample</span></span>
<span><span class="va">reco_csg</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="va">base_csg</span>, <span class="fl">3</span>, <span class="va">htsrec</span>, C <span class="op">=</span> <span class="va">agg_mat</span>, res <span class="op">=</span> <span class="va">res</span>, comb <span class="op">=</span> <span class="st">"shr"</span>, keep <span class="op">=</span> <span class="st">"recf"</span>, simplify <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="va">reco_csg</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">simplify2array</a></span><span class="op">(</span><span class="va">reco_csg</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">reco_csg</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="cn">NULL</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="va">reco_csg</span>, <span class="fl">3</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="va">x</span><span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span><span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">cons_cs</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="co"># Check the coherency</span></span>
<span><span class="co">#&gt; [1] 1.047084e-09</span></span></code></pre></div>
<p><img src="aticolo_files/figure-html/csplot-1.png" width="700" style="display: block; margin: auto;"></p>
</div>
</div>
<div class="section level3">
<h3 id="temporal-framework">Temporal framework<a class="anchor" aria-label="anchor" href="#temporal-framework"></a>
</h3>
<p>Girolimetto et al. (2023) hanno proposto una generalizzazione del
lavoro di Panagiotelis et al. (2022) per la riconciliazione
probabilistica al caso temporale e cross-temporale. Assumiamo quindi di
voler ottenere le previsioni ricocniliate mensili, trimestrali e annuali
per il numero totale di morti.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Temporal setup</span></span>
<span><span class="va">y</span> <span class="op">&lt;-</span> <span class="va">tdeaths</span></span>
<span><span class="va">m</span> <span class="op">&lt;-</span> <span class="fl">12</span></span>
<span><span class="va">kset</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">12</span>, <span class="fl">3</span>, <span class="fl">1</span><span class="op">)</span></span>
<span><span class="va">kset</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/setNames.html" class="external-link">setNames</a></span><span class="op">(</span><span class="va">kset</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"k"</span>, <span class="va">kset</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">cons_te</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/thf_tools.html">thf_tools</a></span><span class="op">(</span>m <span class="op">=</span> <span class="va">kset</span><span class="op">)</span><span class="op">$</span><span class="va">Zt</span></span>
<span></span>
<span><span class="va">temp_y</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">kset</span>, <span class="va">agg_ts</span>, x <span class="op">=</span> <span class="va">y</span><span class="op">)</span>                         <span class="co"># Aggregated time series list</span></span>
<span><span class="va">fit</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">temp_y</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="https://pkg.robjhyndman.com/forecast/reference/ets.html" class="external-link">ets</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/ts.html" class="external-link">ts</a></span><span class="op">(</span><span class="va">x</span>, frequency <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/time.html" class="external-link">frequency</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">forecast_obj</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">fit</span>, <span class="kw">function</span><span class="op">(</span><span class="va">tsfit</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://generics.r-lib.org/reference/forecast.html" class="external-link">forecast</a></span><span class="op">(</span><span class="va">tsfit</span>, h<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/stats/time.html" class="external-link">frequency</a></span><span class="op">(</span><span class="va">tsfit</span><span class="op">$</span><span class="va">x</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>                      <span class="co"># forecast object</span></span>
<span><span class="va">base</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="va">forecast_obj</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="va">x</span><span class="op">$</span><span class="va">mean</span><span class="op">)</span>              <span class="co"># base mean </span></span>
<span><span class="va">res</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/funprog.html" class="external-link">Reduce</a></span><span class="op">(</span><span class="st">"c"</span>, <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="va">fit</span>, <span class="va">residuals</span>, type<span class="op">=</span><span class="st">'response'</span><span class="op">)</span><span class="op">)</span>   <span class="co"># in-sample residuals (one-step)</span></span></code></pre></div>
<div class="section level4">
<h4 id="bootstrap-approach-1">Bootstrap approach<a class="anchor" aria-label="anchor" href="#bootstrap-approach-1"></a>
</h4>
<p>The <code><a href="../reference/boot_te.html">boot_te()</a></code> function is used to generate a bootstrap
sample for time-series forecasts while keeping a temporal structure. The
function has the same inputs as the equivalent cross-sectional
<code><a href="../reference/boot_cs.html">boot_cs()</a></code>, with an additional parameter <strong>m</strong>
which indicates the maximum order of temporal aggregation. The length of
the block bootstrap is determined by both <strong>m</strong> and
<strong>h</strong>, where <strong>h</strong> refers to the forecast
horizons for the most temporally aggregated series.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Base forecasts' sample</span></span>
<span><span class="va">base_tejb</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/boot_te.html">boot_te</a></span><span class="op">(</span><span class="va">fit</span>, <span class="va">B</span>, m <span class="op">=</span> <span class="va">kset</span><span class="op">)</span><span class="op">$</span><span class="va">sample</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">base_tejb</span><span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span><span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">cons_te</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="co"># Check the coherency</span></span>
<span><span class="co">#&gt; [1] 797123.7</span></span>
<span></span>
<span><span class="co"># Reconciled forecasts' sample</span></span>
<span><span class="va">reco_tejb</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="va">base_tejb</span>, <span class="fl">1</span>, <span class="kw">function</span><span class="op">(</span><span class="va">boot_base</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="fu"><a href="../reference/thfrec.html">thfrec</a></span><span class="op">(</span><span class="va">boot_base</span>, m <span class="op">=</span> <span class="va">kset</span>, res <span class="op">=</span> <span class="va">res</span>, comb <span class="op">=</span> <span class="st">"wlsv"</span>, keep <span class="op">=</span> <span class="st">"recf"</span><span class="op">)</span><span class="op">}</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">reco_tejb</span><span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span><span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">cons_te</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="co"># Check the coherency</span></span>
<span><span class="co">#&gt; [1] 4.35648e-09</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="gaussian-approach-1">Gaussian approach<a class="anchor" aria-label="anchor" href="#gaussian-approach-1"></a>
</h4>
<p>For the Gaussian approach (Girolimetto et al. 2023), the idea is very
similar to what we saw previously. In this case, to calculate the
covariance matrix of the base forecasts, we can use multi-step residuals
organized in matrix form through the <code><a href="../reference/residuals_matrix.html">residuals_matrix()</a></code>
function.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Multi-step residuals</span></span>
<span><span class="va">hres</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">fit</span>, <span class="kw">function</span><span class="op">(</span><span class="va">mod</span><span class="op">)</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/stats/time.html" class="external-link">frequency</a></span><span class="op">(</span><span class="va">mod</span><span class="op">$</span><span class="va">x</span><span class="op">)</span>, <span class="kw">function</span><span class="op">(</span><span class="va">h</span><span class="op">)</span> </span>
<span>    <span class="fu"><a href="https://rdrr.io/r/stats/residuals.html" class="external-link">residuals</a></span><span class="op">(</span><span class="va">mod</span>, type<span class="op">=</span><span class="st">'response'</span>, h <span class="op">=</span> <span class="va">h</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">hres</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/funprog.html" class="external-link">Reduce</a></span><span class="op">(</span><span class="st">"c"</span>, <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">hres</span>, <span class="va">arrange_hres</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co"># Re-arrenge multi-step residuals in a matrix form</span></span>
<span><span class="va">mres</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/residuals_matrix.html">residuals_matrix</a></span><span class="op">(</span><span class="va">hres</span>, m <span class="op">=</span> <span class="va">kset</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Base forecasts' sample</span></span>
<span><span class="va">base_teg</span> <span class="op">&lt;-</span> <span class="fu">MASS</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/MASS/man/mvrnorm.html" class="external-link">mvrnorm</a></span><span class="op">(</span>n <span class="op">=</span> <span class="va">B</span>, mu <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/unlist.html" class="external-link">unlist</a></span><span class="op">(</span><span class="va">base</span><span class="op">)</span>, Sigma <span class="op">=</span> <span class="fu"><a href="../reference/shrink_estim.html">shrink_estim</a></span><span class="op">(</span><span class="va">mres</span><span class="op">)</span><span class="op">$</span><span class="va">scov</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">base_teg</span><span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span><span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">cons_te</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="co"># Check the coherency</span></span>
<span><span class="co">#&gt; [1] 2929280</span></span>
<span></span>
<span><span class="co"># Reconciled forecasts' sample</span></span>
<span><span class="va">reco_teg</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="va">base_teg</span>, <span class="fl">1</span>, <span class="va">thfrec</span>, m <span class="op">=</span> <span class="va">kset</span>, comb <span class="op">=</span> <span class="st">"wlsv"</span>, res <span class="op">=</span> <span class="va">res</span>, keep <span class="op">=</span> <span class="st">"recf"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">reco_teg</span><span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span><span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">cons_te</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="co"># Check the coherency</span></span>
<span><span class="co">#&gt; [1] 3.728587e-09</span></span></code></pre></div>
<p><img src="aticolo_files/figure-html/teplot-1.png" width="700" style="display: block; margin: auto;"></p>
</div>
</div>
<div class="section level3">
<h3 id="cross-temporal-framework">Cross-temporal framework<a class="anchor" aria-label="anchor" href="#cross-temporal-framework"></a>
</h3>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Cross-temporal setup</span></span>
<span><span class="va">ctlungDeaths</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">kset</span>, <span class="va">agg_ts</span>, x <span class="op">=</span> <span class="va">lungDeaths</span><span class="op">)</span> <span class="co"># Aggregated multivariate time series list</span></span>
<span></span>
<span><span class="va">fit</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">ctlungDeaths</span>, <span class="kw">function</span><span class="op">(</span><span class="va">tsk</span><span class="op">)</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="va">tsk</span>, <span class="fl">2</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="https://pkg.robjhyndman.com/forecast/reference/ets.html" class="external-link">ets</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/ts.html" class="external-link">ts</a></span><span class="op">(</span><span class="va">x</span>, frequency <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/time.html" class="external-link">frequency</a></span><span class="op">(</span><span class="va">tsk</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">forecast_obj</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">fit</span>, <span class="kw">function</span><span class="op">(</span><span class="va">fitk</span><span class="op">)</span>           <span class="co"># forecast object</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">fitk</span>, <span class="kw">function</span><span class="op">(</span><span class="va">tsfit</span><span class="op">)</span> </span>
<span>    <span class="fu"><a href="https://generics.r-lib.org/reference/forecast.html" class="external-link">forecast</a></span><span class="op">(</span><span class="va">tsfit</span>, h<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/stats/time.html" class="external-link">frequency</a></span><span class="op">(</span><span class="va">tsfit</span><span class="op">$</span><span class="va">x</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">base</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="va">forecast_obj</span>, <span class="kw">function</span><span class="op">(</span><span class="va">fmodk</span><span class="op">)</span>     <span class="co"># base mean </span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="va">fmodk</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="va">x</span><span class="op">$</span><span class="va">mean</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">res</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/funprog.html" class="external-link">Reduce</a></span><span class="op">(</span><span class="st">"rbind"</span>, <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="va">fit</span>, <span class="kw">function</span><span class="op">(</span><span class="va">fitk</span><span class="op">)</span>    <span class="co"># in-sample residuals (one-step)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="va">fitk</span>, <span class="va">residuals</span>, type<span class="op">=</span><span class="st">'response'</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<div class="section level4">
<h4 id="bootstrap-approach-2">Bootstrap approach<a class="anchor" aria-label="anchor" href="#bootstrap-approach-2"></a>
</h4>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Base forecasts' sample</span></span>
<span><span class="va">base_ctjb</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/boot_ct.html">boot_ct</a></span><span class="op">(</span><span class="va">fit</span>, <span class="va">B</span>, m <span class="op">=</span> <span class="va">kset</span><span class="op">)</span><span class="op">$</span><span class="va">sample</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="va">base_ctjb</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="va">x</span><span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span><span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">cons_cs</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 922277</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="va">base_ctjb</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">cons_te</span><span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span><span class="va">x</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 1980608</span></span>
<span></span>
<span><span class="co"># Reconciled forecasts' sample</span></span>
<span><span class="va">reco_ctjb</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">base_ctjb</span>, <span class="kw">function</span><span class="op">(</span><span class="va">boot_base</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="fu"><a href="../reference/octrec.html">octrec</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">boot_base</span><span class="op">)</span>, m <span class="op">=</span> <span class="va">kset</span>, C <span class="op">=</span> <span class="va">agg_mat</span>, res <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">res</span><span class="op">)</span>, comb <span class="op">=</span> <span class="st">"bdshr"</span>, keep <span class="op">=</span> <span class="st">"recf"</span><span class="op">)</span><span class="op">}</span><span class="op">)</span></span>
<span><span class="va">reco_ctjb</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">reco_ctjb</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu">`rownames&lt;-`</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span>, <span class="cn">NULL</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="va">reco_ctjb</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="va">x</span><span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span><span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">cons_cs</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 4.825381e-09</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="va">reco_ctjb</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">cons_te</span><span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span><span class="va">x</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 7.033407e-09</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="gaussian-approach-2">Gaussian approach<a class="anchor" aria-label="anchor" href="#gaussian-approach-2"></a>
</h4>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Multi-step residuals</span></span>
<span><span class="va">hres</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">fit</span>, <span class="kw">function</span><span class="op">(</span><span class="va">fitk</span><span class="op">)</span>    <span class="co"># in-sample residuals (one-step)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/stats/time.html" class="external-link">frequency</a></span><span class="op">(</span><span class="va">fitk</span><span class="op">$</span><span class="va">tdeaths</span><span class="op">$</span><span class="va">x</span><span class="op">)</span>, <span class="kw">function</span><span class="op">(</span><span class="va">h</span><span class="op">)</span> </span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="va">fitk</span>, <span class="va">residuals</span>, type<span class="op">=</span><span class="st">'response'</span>, h <span class="op">=</span> <span class="va">h</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">hres</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/funprog.html" class="external-link">Reduce</a></span><span class="op">(</span><span class="st">"rbind"</span>, <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">hres</span>, <span class="va">arrange_hres</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co"># Re-arrenge multi-step residuals in a matrix form</span></span>
<span><span class="va">mres</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/residuals_matrix.html">residuals_matrix</a></span><span class="op">(</span><span class="va">hres</span>, m <span class="op">=</span> <span class="va">kset</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Base forecasts' sample</span></span>
<span><span class="va">base_ctg</span> <span class="op">&lt;-</span> <span class="fu">MASS</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/MASS/man/mvrnorm.html" class="external-link">mvrnorm</a></span><span class="op">(</span>n <span class="op">=</span> <span class="va">B</span>, mu <span class="op">=</span> <span class="fu"><a href="../reference/residuals_matrix.html">residuals_matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/funprog.html" class="external-link">Reduce</a></span><span class="op">(</span><span class="st">"rbind"</span>, <span class="va">base</span><span class="op">)</span><span class="op">)</span>, m <span class="op">=</span> <span class="va">kset</span><span class="op">)</span>, </span>
<span>                          Sigma <span class="op">=</span> <span class="fu"><a href="../reference/shrink_estim.html">shrink_estim</a></span><span class="op">(</span><span class="va">mres</span><span class="op">)</span><span class="op">$</span><span class="va">scov</span><span class="op">)</span></span>
<span><span class="va">base_ctg</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="va">base_ctg</span>, <span class="fl">1</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="va">x</span>, ncol <span class="op">=</span> <span class="fl">3</span><span class="op">)</span>, simplify <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="va">base_ctg</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="va">x</span><span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span><span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">cons_cs</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 5015786</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="va">base_ctg</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">cons_te</span><span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span><span class="va">x</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 5966849</span></span>
<span></span>
<span><span class="co"># Reconciled forecasts' sample</span></span>
<span><span class="va">reco_ctg</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">base_ctg</span>, <span class="kw">function</span><span class="op">(</span><span class="va">boot_base</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="fu"><a href="../reference/octrec.html">octrec</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">boot_base</span><span class="op">)</span>, m <span class="op">=</span> <span class="va">kset</span>, C <span class="op">=</span> <span class="va">agg_mat</span>, res <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">res</span><span class="op">)</span>, comb <span class="op">=</span> <span class="st">"bdshr"</span>, keep <span class="op">=</span> <span class="st">"recf"</span><span class="op">)</span><span class="op">}</span><span class="op">)</span></span>
<span><span class="va">reco_ctg</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">reco_ctg</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu">`rownames&lt;-`</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span>, <span class="cn">NULL</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="va">reco_ctg</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="va">x</span><span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span><span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">cons_cs</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 5.563948e-09</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="va">reco_ctg</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">cons_te</span><span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span><span class="va">x</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 9.904568e-09</span></span></code></pre></div>
<p><img src="aticolo_files/figure-html/ctplot-1.png" width="700" style="display: block; margin: auto;"></p>
</div>
</div>
<div class="section level2">
<h2 id="references">References<a class="anchor" aria-label="anchor" href="#references"></a>
</h2>
<p>Girolimetto, D., Athanasopoulos, G., Di Fonzo, T., &amp; Hyndman, R.
J. (2023), Cross-temporal Probabilistic Forecast Reconciliation, <a href="https://doi.org/10.48550/arXiv.2303.17277" class="external-link uri">https://doi.org/10.48550/arXiv.2303.17277</a> .</p>
<p>Hyndman R, Athanasopoulos G, Bergmeir C, Caceres G, Chhay L,
O’Hara-Wild M, Petropoulos F, Razbash S, Wang E, Yasmeen F (2023).
<em>forecast: Forecasting functions for time series and linear
models</em> . R package version 8.20, <a href="https://pkg.robjhyndman.com/forecast/" class="external-link uri">https://pkg.robjhyndman.com/forecast/</a>.</p>
<p>Panagiotelis, A., Gamakumara, P., Athanasopoulos, G. &amp; Hyndman,
R. J. (2023), Probabilistic orecast reconciliation: Properties,
evaluation and score optimisation, <em>European Journal of Operational
Research</em> 306(2), 693–706.</p>
<p>Venables, W. N. &amp; Ripley, B. D. (2002), Modern Applied Statistics
with S, fourth edn, Springer, New York. ISBN 0-387-95457-0.</p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by Daniele Girolimetto, Tommaso Di Fonzo.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

      </footer>
</div>

  


  

  </body>
</html>
